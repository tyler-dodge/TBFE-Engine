UiLua={} 
function UiLua.ShowLoadWindow()
   if LoadWindow==nil then
      local SaveNames,SaveLength
      LoadWindow=UI.CreateWindow((TBFE.TBFE_Render_SCREEN_WIDTH-300)/2,
				 (TBFE.TBFE_Render_SCREEN_HEIGHT-300)/2,"LoadGame")
      engine:AddWindow(LoadWindow)
      engine:AddEvent("Cancel",LoadWindow:SelectElement("picCancel"),
		      LoadWindow,"UiLua.ShowLoadWindow();Action='Title'",Misc.CLICK)
      engine:AddEvent("Load",LoadWindow:SelectElement("picLoad"),
		      LoadWindow,"TbfeFile.LoadGame(file);Action='begin';UiLua.ShowLoadWindow()",Misc.CLICK)
      SaveNames,SaveLength=UiLua.GetSaves("Data/SaveLocations")
      for i=1,SaveLength,1 do
	 LoadWindow:SelectElement("lblSlot"..i).Special=SaveNames[i]
	 LoadWindow:SelectElement("lblSlot"..i):Reload()
	 engine:AddEvent("Select"..i,LoadWindow:SelectElement("lblSlot"..i),LoadWindow,"file='"..SaveNames[i].."';ChangeSelect("..i..")",Misc.CLICK)
      end
      file=SaveNames[1]
   elseif LoadWindow.Visible==true then
      engine:SelectEvent("GameMenu").Enabled=true
      LoadWindow.Visible=false
   else
      engine:SelectEvent("GameMenu").Enabled=false
      LoadWindow.Visible=true
   end
end
function UiLua.ShowSaveMenu()
   if SaveMenu==nil then
      SaveMenu=UI.CreateWindow((TBFE.TBFE_Render_SCREEN_WIDTH-300)/2,
			       (TBFE.TBFE_Render_SCREEN_HEIGHT-100)/2,
			       "SaveGame")
      engine:AddWindow(SaveMenu)
      engine:AddEvent("Cancel Save",SaveMenu:SelectElement("picCancel"),
		      SaveMenu,"UiLua.ShowSaveMenu();UiLua.ShowMenu()",Misc.CLICK)
      engine:AddEvent("Select Text",SaveMenu:SelectElement("txtName"),
		      SaveMenu,
		      "TBFE.TBFE_Base_KeyTarget=SaveMenu:SelectElement('txtName')",Misc.CLICK)
      engine:AddEvent("Select Text",SaveMenu:SelectElement("picSave"),
		      SaveMenu,
		      "TbfeFile.SaveGame('Save/'..SaveMenu:SelectElement('txtName').Special); \
		      TBFE.TBFE_Base_KeyTarget=nil; \
		      SaveMenu.Visible=false",Misc.CLICK)
   elseif SaveMenu.Visible==true then
      SaveMenu.Visible=false
      engine:SelectEvent("GameMenu").Enabled=true
   else
      SaveMenu.Visible=true
      engine:SelectEvent("GameMenu").Enabled=false
   end
end
function UiLua.ShowMenu()
   if GameMenu==nil then
      GameMenu=UI.CreateWindow((TBFE.TBFE_Render_SCREEN_WIDTH-100)/2,
			       (TBFE.TBFE_Render_SCREEN_HEIGHT-200)/2,
			       "Menu")
      engine:AddEvent("Quit",GameMenu:SelectElement("lblQuit"),GameMenu,
		      "engine.Logic.quit=true",Misc.CLICK)
      engine:AddEvent("Load",GameMenu:SelectElement("lblLoad"),GameMenu,
		      "UiLua.ShowLoadWindow();UiLua.ShowMenu()",Misc.CLICK)
      engine:AddEvent("Save",GameMenu:SelectElement("lblSave"),GameMenu,
		      "UiLua.ShowSaveMenu();UiLua.ShowMenu()",Misc.CLICK)
      engine:AddWindow(GameMenu)      
      TBFE.TBFE_Base_KeyControl=false
   elseif GameMenu.Visible==true then
      TBFE.TBFE_Base_KeyControl=true
      GameMenu.Visible=false
   elseif GameMenu.Visible==false then
      TBFE.TBFE_Base_KeyControl=false
      GameMenu.Visible=true
   end
end
function UiLua.GetSaves(FileLocations)
   local File=io.open(FileLocations..".cfg")
   local Locations={}
   local Line
   local i=1
   Line="Start"
   while Line~=nil do
      Line=File:read()
      if Line~=nil then
	 Locations[i]=Line
	 i=i+1
      end
   end
   return Locations,i-1
end

function UiLua.CheckChangeTool()
   --TODO: GetTool
   --if CurrentTool~=TBFE.TBFE_Base_MainPlayer:GetTool() then
   --  CurrentTool=TBFE.TBFE_Base_MainPlayer:GetTool()
   --  CurrentToolIcon=Stats:SelectElement("CurrentTool")
   --  CurrentToolIcon.Special="images/UI/ToolIcons.png("..((CurrentTool+1)*50)..";0;50;50)"
   --end
   --CurrentToolAmount=TBFE.TBFE_Base_MainPlayer.ToolInventory:GetAmount(TBFE.TBFE_Base_MainPlayer.currentTool)
   --Stats:SelectElement("CurrentToolAmount").Special=CurrentToolAmount
   --if CurrentToolAmount==1 or CurrentToolAmount==0 then
   --  Stats:SelectElement("CurrentToolAmount").Special=" "
   -- if CurrentTool==-1 then
   -- CurrentToolIcon.Special="images/UI/ToolIcons.png(0;0;50;50)"
   --    end	 
   --end
   --Stats:SelectElement("CurrentToolAmount"):Reload()
end
function UiLua.UpdateInventory()
   for i=1,3,1 do
      local Position=PlayerInventory:Get(i-1)
      TbfeFile.SaveData.Data['Inventory'..(i-1)]=Position
      if Position==-1 then
	 Position=0
      end
      Position=Position*50
      InventoryWindow:SelectElement("Slot"..i).Special="images/UI/Items.png("..Position..";0;50;50)"
   end
end
function UiLua.ShowInventory()
   if InventoryWindow.Visible==true then
      InventoryWindow.Visible=false
   else
      InventoryWindow.Visible=true
   end
end
